---
const navigation = [
  { name: '主页', href: '/' },
  { name: '下载', href: '/downloads' },
  { name: '功能截图', href: '/about' },
  { name: '更新日志', href: '/changelogs' },
  { name: '常见问题', href: '/wiki' },
];

const currentPath = Astro.url.pathname;
const isActive = (href: string) => {
    if (href === '/') {
        return currentPath === '/';
    }
    return currentPath.startsWith(href);
};
---

<nav class="fixed top-0 z-50 w-full backdrop-blur-md bg-surface-base/80 transition-all duration-300">
  <div class="max-w-7xl mx-auto px-4 py-1 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <!-- Mobile Menu Button -->
      <div class="flex items-center md:hidden">
        <button type="button" id="mobile-menu-btn" class="inline-flex items-center justify-center p-2 rounded-md hover:text-primary hover:bg-surface-highlight focus:outline-none transition-colors">
          <span class="sr-only">Open main menu</span>
          <i class="mgc_menu_line text-lg"></i>
        </button>
      </div>

      <!-- Logo & Desktop Nav -->
      <div class="flex-1 flex items-center justify-center md:justify-start">
        <a href="/" class="shrink-0 flex items-center mx-2 group">
          <img alt="logo" src="/logo.png" class:list={['h-7 w-7 transition-transform group-hover:scale-105', { '-translate-x-1/2 md:translate-0': currentPath !== '/' }]}>
        </a>
        <div class="hidden md:block md:ml-10">
          <div class="flex space-x-1">
            {navigation.map((item) => (
              <a
                href={item.href}
                class:list={[
                  'px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200',
                  isActive(item.href)
                    ? 'bg-surface-highlight text-primary' 
                    : 'text-text-muted hover:text-text-main hover:bg-surface-highlight/50'
                ]}
                aria-current={isActive(item.href) ? 'page' : undefined}
              >
                {item.name}
              </a>
            ))}
          </div>
        </div>
      </div>
      
      <!-- Right Side Actions -->
      <div class:list={['flex items-center', { 'hidden': currentPath !== '/' }]}>
        <button
          type="button"
          id="danmaku-toggle"
          class="inline-flex items-center justify-center p-2 rounded-md hover:text-primary hover:bg-surface-highlight focus:outline-none transition-colors"
          aria-label="Toggle Danmaku"
        >
          <i id="danmaku-icon" class="mgc_danmaku_fill text-lg"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div class="hidden md:hidden border-t border-surface-highlight bg-surface-base" id="mobile-menu">
    <div class="px-2 pt-3 pb-5 space-y-1 sm:px-3">
      {navigation.map((item) => (
        <a
          href={item.href}
          class:list={[
            'block px-3 py-2 rounded-md transition-colors',
            isActive(item.href)
              ? 'bg-surface-highlight text-primary'
              : 'text-text-muted hover:text-text-main hover:bg-surface-highlight/50'
          ]}
          aria-current={isActive(item.href) ? 'page' : undefined}
        >
          {item.name}
        </a>
      ))}
    </div>
  </div>
</nav>

<script>
  const btn = document.getElementById('mobile-menu-btn');
  const menu = document.getElementById('mobile-menu');

  if (btn && menu) {
    btn.addEventListener('click', () => {
      menu.classList.toggle('hidden');
      btn.setAttribute('aria-expanded', String(!menu.classList.contains('hidden')))
    });
  }
  
  const danmakuToggle = document.getElementById('danmaku-toggle');
  const danmakuIcon = document.getElementById('danmaku-icon');
  const DANMAKU_EVENT = 'toggle-danmaku';
  
  let isDanmakuEnabled = localStorage.getItem('danmaku-enabled') === 'true';
  
  function updateIcon() {
    if (danmakuIcon) {
       if (isDanmakuEnabled) {
         danmakuIcon.className = 'mgc_danmaku_fill text-xl';
         danmakuIcon.style.color = 'var(--color-primary)'; // Optional: highlight when active
       } else {
         danmakuIcon.className = 'mgc_danmaku_off_fill text-xl';
         danmakuIcon.style.color = ''; // Reset color
       }
    }
  }

  if (danmakuToggle) {
    updateIcon();
    
    danmakuToggle.addEventListener('click', () => {
      isDanmakuEnabled = !isDanmakuEnabled;
      localStorage.setItem('danmaku-enabled', String(isDanmakuEnabled));
      updateIcon();
      window.dispatchEvent(new CustomEvent(DANMAKU_EVENT, { detail: { enabled: isDanmakuEnabled } }));
    });
  }
</script>
