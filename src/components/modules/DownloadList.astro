---
// DownloadList.astro - Client Side Fetching Version

const PlatType = {
  'android-universal': '安卓 APK',
  'windows-x86_64': 'Windows',
  'macos-aarch64': 'macOS (M系列芯片)',
  'macos-x86_64': 'macOS (Intel 芯片)',
  'linux-x86_64': 'Linux AppImage',
  'ios-aarch64': 'iOS IPA（自签）',
};

const PlatformIcons = {
  'android-universal': 'mgc_android_line',
  'windows-x86_64': 'mgc_windows_line',
  'macos-aarch64': 'mgc_apple_line',
  'macos-x86_64': 'mgc_apple_line',
  'linux-x86_64': 'mgc_linux_line',
  'ios-aarch64': 'mgc_apple_line',
};

const guidanceLink = {
  'android-universal': '',
  'windows-x86_64': '',
  'macos-aarch64': '',
  'linux-x86_64': '/wiki/Linux-安装说明',
  'ios-aarch64': '/wiki/iOS-自签',
  'macos-x86_64': '/wiki/macOS-Intel-芯片版本安装教程',
};
---

<div class="max-w-4xl mx-auto min-h-[500px] relative">
  <!-- Tabs -->
  <div class="flex justify-center mb-8 bg-bg-card p-1 rounded-full w-fit mx-auto border border-border-subtle">
    <button
      class="tab-btn px-6 py-2 rounded-full text-sm font-medium transition-all duration-200 text-txt-main bg-border-subtle"
      data-target="stable"
      id="btn-stable"
    >
      稳定版本
    </button>
    <button
      class="tab-btn px-6 py-2 rounded-full text-sm font-medium transition-all duration-200 text-txt-muted hover:text-txt-main"
      data-target="beta"
      id="btn-beta"
    >
      测试版本
    </button>
  </div>

  <!-- Loading Spinner -->
  <div id="loading-spinner" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-bg-base/50 backdrop-blur-sm transition-opacity duration-300">
    <div class="spinner mb-4"></div>
    <p class="text-txt-muted">正在获取最新版本信息...</p>
  </div>

  <!-- Content Container -->
  <div id="download-container" class="opacity-0 transition-opacity duration-300">
      <!-- Stable Section -->
      <div id="content-stable" class="download-content space-y-4"></div>
      <!-- Beta Section -->
      <div id="content-beta" class="download-content hidden space-y-4"></div>
  </div>
</div>

<script is:inline define:vars={{ PlatType, PlatformIcons, guidanceLink }}>
  const apiBase = 'https://danmaku-cn.myani.org/v1/updates/latest';

  function ts2str(ts) {
    const date = new Date(ts * 1000);
    const y = date.getFullYear().toString();
    const m = (date.getMonth() + 1).toString().padStart(2, '0');
    const d = date.getDate().toString().padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  function replaceGhproxyLinks(downloadMap) {
      const result = { ...downloadMap };
      for (const platform in result) {
        const urls = result[platform];
        if (urls && urls.length >= 2) {
          const secondUrl = urls[1];
          if (secondUrl && secondUrl.startsWith('https://mirror.ghproxy.com/?q=https://github.com/open-ani/ani/releases/download/')) {
            const githubUrl = secondUrl.replace('https://mirror.ghproxy.com/?q=', '');
            urls[1] = `https://ghfast.top/${githubUrl}`;
          }
        }
      }
      return result;
  }

  async function fetchData(type) {
    try {
      const res = await fetch(`${apiBase}?releaseClass=${type === 'beta' ? 'alpha' : 'stable'}`);
      if (!res.ok) throw new Error('Network response was not ok');
      return await res.json();
    } catch (e) {
      console.error(e);
      return null;
    }
  }

  function createReleaseCard(release, data, type) {
      const links = data.downloadUrlAlternativesMap[release] || [];
      if (links.length === 0) return '';

      const buttonsHtml = links.map((link, idx) => `
        <a href="${link}" class="inline-flex items-center px-4 py-2 rounded-btn text-sm font-medium transition-colors ${
            idx === 0 
            ? 'bg-accent text-on-accent hover:bg-accent/90' 
            : 'bg-transparent border border-border-subtle text-txt-main hover:bg-border-subtle'
        }">
            <i class="${idx === 0 ? 'mgc_download_2_fill' : 'mgc_download_line'} mr-1.5"></i>
            ${idx === 0 ? '下载' : '备用'}
        </a>
      `).join('');

      const guideLink = guidanceLink[release] ? `
        <a href="${guidanceLink[release]}" class="inline-flex items-center px-4 py-2 rounded-btn text-sm font-medium text-txt-muted hover:text-accent hover:bg-bg-base transition-colors">
            <i class="mgc_book_2_line mr-1.5"></i>
            教程
        </a>
      ` : '';

      return `
        <div class="flex flex-col sm:flex-row items-center justify-between p-6 bg-bg-card rounded-card border border-border-subtle hover:border-accent/30 transition-all duration-200 gap-4">
            <div class="flex items-center gap-4 w-full sm:w-auto">
                <div class="w-12 h-12 rounded-full bg-bg-base flex items-center justify-center border border-border-subtle text-accent shrink-0">
                    <i class="${PlatformIcons[release] || 'mgc_file_line'} text-2xl"></i>
                </div>
                <div class="text-left">
                    <p class="font-medium text-lg text-txt-main">${PlatType[release] || release}</p>
                    <small class="text-txt-muted">v${data.version}</small>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-2 w-full sm:w-auto justify-end">
                ${buttonsHtml}
                ${guideLink}
            </div>
        </div>
      `;
  }

  async function init() {
      const spinner = document.getElementById('loading-spinner');
      const container = document.getElementById('download-container');
      const stableContainer = document.getElementById('content-stable');
      const betaContainer = document.getElementById('content-beta');

      const [stableData, betaData] = await Promise.all([
          fetchData('stable'),
          fetchData('beta')
      ]);

      // Render Stable
      if (stableData) {
        const fixedMap = replaceGhproxyLinks(stableData.downloadUrlAlternativesMap);
        stableData.downloadUrlAlternativesMap = fixedMap;
        
        let html = `
            <div class="text-center mb-6 text-txt-muted flex items-center justify-center gap-2">
                <i class="mgc_time_line"></i>
                <span>更新时间：${ts2str(stableData.publishTime)}</span>
            </div>
            <div class="grid gap-4">
        `;
        
        Object.keys(PlatType).forEach(key => {
            html += createReleaseCard(key, stableData, 'stable');
        });
        html += '</div>';

        if (stableData.qrcodeUrls && stableData.qrcodeUrls[0]) {
            html += `
                <div class="mt-8 p-6 bg-bg-card rounded-card border border-border-subtle flex flex-col items-center justify-center text-center">
                    <span class="mb-4 text-txt-muted flex items-center gap-2">
                        <i class="mgc_cellphone_line"></i>
                        手机扫码下载
                    </span>
                    <div class="p-2 bg-white rounded-lg">
                        <img alt="qrcode" src="${stableData.qrcodeUrls[0]}" class="w-48 h-48" />
                    </div>
                </div>
            `;
        }
        stableContainer.innerHTML = html;
      } else {
          stableContainer.innerHTML = '<div class="p-8 text-center text-txt-muted">加载失败</div>';
      }

      // Render Beta
      if (betaData) {
        const fixedMap = replaceGhproxyLinks(betaData.downloadUrlAlternativesMap);
        betaData.downloadUrlAlternativesMap = fixedMap;

        let html = `
           <div class="p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-card flex items-start gap-3 text-yellow-500 mb-6">
             <i class="mgc_warning_line text-xl mt-0.5"></i>
             <span class="text-sm">Alpha 测试版可能存在较多问题和不稳定因素，建议仅供尝鲜使用。</span>
           </div>
           <div class="text-center mb-6 text-txt-muted flex items-center justify-center gap-2">
             <i class="mgc_time_line"></i>
             <span>更新时间：${ts2str(betaData.publishTime)}</span>
           </div>
           <div class="grid gap-4">
        `;
        
        Object.keys(PlatType).forEach(key => {
            html += createReleaseCard(key, betaData, 'beta');
        });
        html += '</div>';
        betaContainer.innerHTML = html;
      }

      // Hide spinner, show content
      spinner.classList.add('opacity-0', 'pointer-events-none');
      container.classList.remove('opacity-0');
      
      // Tab Logic
      const btns = document.querySelectorAll('.tab-btn');
      const contents = document.querySelectorAll('.download-content');

      btns.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-target');
          
          // Toggle Content
          contents.forEach(c => {
              if(c.id === `content-${target}`) c.classList.remove('hidden');
              else c.classList.add('hidden');
          });

          // Toggle Buttons
          btns.forEach(b => {
              if(b === btn) {
                  b.classList.remove('text-txt-muted', 'hover:text-txt-main');
                  b.classList.add('bg-border-subtle', 'text-txt-main');
              } else {
                  b.classList.add('text-txt-muted', 'hover:text-txt-main');
                  b.classList.remove('bg-border-subtle', 'text-txt-main');
              }
          });
        });
      });
  }

  init();
</script>

