---
import Layout from "../layouts/Changelog.astro";
import { marked } from "marked";

const response = await fetch(
  "https://danmaku-global.myani.org/v1/updates/incremental/details?clientVersion=4.0.0&clientPlatform=android&clientArch=x86_64&releaseClass=stable",
);
interface dataType {
  updates: Array<{
    version: string;
    downloadUrlAlternatives: string[];
    publishTime: number;
    description: string;
  }>;
}
const buffer = Buffer.from(await response.arrayBuffer());
const text = buffer.toString("utf-8");

const data: dataType = await JSON.parse(text);
const { updates } = data;
let html =
  marked.parse(`[![GitHub Release](https://img.shields.io/github/v/release/open-ani/animeko?sort=semver&display_name=tag&style=flat-square)](https://github.com/open-ani/animeko/releases/latest)

> 本页面仅展示 v4.x.x 版本的更新日志, 且不包括 Beta 与 Pre-release 版本.`);

updates.forEach((update) => {
  if (update.version.includes("beta") || update.version.includes("alpha"))
    return;
  html += marked.parse(`## ${update.version}\n\n${update.description}`) + "\n";
});
---

<Layout>
  <h1>Changelog</h1>
  <article set:html={html} />
</Layout>
